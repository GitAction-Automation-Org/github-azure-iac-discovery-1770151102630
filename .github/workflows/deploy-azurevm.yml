name: Provision Azure VM

on:
  workflow_dispatch:
    inputs:
      deploymentID:
        description: "Unique deployment ID (used only for tagging)"
        required: true
        type: string

      vmName:
        description: "Base name for VM and related resources"
        required: false
        default: "defaultvm"
        type: string

      resourceGroup:
        description: "Resource Group where VM will be deployed"
        required: true
        default: "automationdonotdelete"
        type: string

      region:
        description: "Azure region"
        required: true
        default: "westus"
        type: string

      adminUsername:
        description: "Admin username for the VM"
        required: false
        default: "azureuser"
        type: string

      vmSize:
        description: "Azure VM Size"
        required: false
        default: "Standard_D2s_v3"
        type: string

      vnetAddressPrefix:
        description: "VNet CIDR range"
        required: false
        default: "10.0.0.0/16"
        type: string

      subnetPrefix:
        description: "Subnet CIDR range"
        required: false
        default: "10.0.0.0/24"
        type: string

      publicIpEnabled:
        description: "Create Public IP?"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

      azureCredentialsSecret:
        description: "GitHub secret name containing Azure credentials JSON"
        required: false
        default: "AZURE_CREDENTIALS"
        type: string

run-name: ${{ github.workflow }}-${{ inputs.deploymentID }}

jobs:
  create-vm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # =============================
      # Azure Login (Service Principal)
      # =============================
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets[github.event.inputs.azureCredentialsSecret] }}

      - name: Verify Azure Login
        run: az account show

      # =============================
      # Provision Azure VM
      # =============================
      - name: Provision Azure VM
        run: |
          set -e

          # === Inputs ===
          DEPLOYMENT_ID="${{ github.event.inputs.deploymentID }}"
          VM_NAME_PREFIX="${{ github.event.inputs.vmName }}"
          RG="${{ github.event.inputs.resourceGroup }}"
          LOCATION="${{ github.event.inputs.region }}"
          ADMIN_USERNAME="${{ github.event.inputs.adminUsername }}"
          VM_SIZE="${{ github.event.inputs.vmSize }}"
          ADDRESS_PREFIX="${{ github.event.inputs.vnetAddressPrefix }}"
          SUBNET_PREFIX="${{ github.event.inputs.subnetPrefix }}"
          PUBLIC_IP_ENABLED="${{ github.event.inputs.publicIpEnabled }}"

          # === Resource Names ===
          VNET_NAME="${VM_NAME_PREFIX}-vnet"
          SUBNET_NAME="${VM_NAME_PREFIX}-subnet"
          NIC_NAME="${VM_NAME_PREFIX}-nic"
          PUBLIC_IP_NAME="${VM_NAME_PREFIX}-pip"
          VM_NAME="${VM_NAME_PREFIX}-vm"

          # === VM Image (Shared Image Gallery) ===
          IMAGE_ID="/subscriptions/afcb0d04-e5dc-41bc-a1a5-1301e875b563/resourceGroups/CCOE-IMAGE-RG/providers/Microsoft.Compute/galleries/CCOE_Compute_Gallery1/images/ServiceNow_Ubuntu20_Image/versions/21.0.0"

          STORAGE_TYPE="Standard_LRS"

          echo "üöÄ Creating Resource Group (if not exists)"
          az group create \
            --name "$RG" \
            --location "$LOCATION" \
            --tags deploymentID="$DEPLOYMENT_ID"

          echo "üåê Creating Virtual Network"
          az network vnet create \
            --resource-group "$RG" \
            --name "$VNET_NAME" \
            --address-prefix "$ADDRESS_PREFIX" \
            --subnet-name "$SUBNET_NAME" \
            --subnet-prefix "$SUBNET_PREFIX" \
            --tags deploymentID="$DEPLOYMENT_ID"

          if [ "$PUBLIC_IP_ENABLED" = "true" ]; then
            echo "üåê Creating Public IP"
            az network public-ip create \
              --resource-group "$RG" \
              --name "$PUBLIC_IP_NAME" \
              --sku Standard \
              --allocation-method Static \
              --tags deploymentID="$DEPLOYMENT_ID"

            PUBLIC_IP_ARG="--public-ip-address $PUBLIC_IP_NAME"
          else
            echo "‚ö†Ô∏è Skipping Public IP creation"
            PUBLIC_IP_ARG=""
          fi

          echo "üåê Creating NIC"
          az network nic create \
            --resource-group "$RG" \
            --name "$NIC_NAME" \
            --vnet-name "$VNET_NAME" \
            --subnet "$SUBNET_NAME" \
            $PUBLIC_IP_ARG \
            --tags deploymentID="$DEPLOYMENT_ID"

          echo "üíª Creating VM"
          az vm create \
            --resource-group "$RG" \
            --name "$VM_NAME" \
            --nics "$NIC_NAME" \
            --image "$IMAGE_ID" \
            --size "$VM_SIZE" \
            --storage-sku "$STORAGE_TYPE" \
            --admin-username "$ADMIN_USERNAME" \
            --generate-ssh-keys \
            --tags deploymentID="$DEPLOYMENT_ID"

          echo "‚úÖ VM $VM_NAME created successfully"
          echo "üìç Resource Group: $RG"
          echo "üåç Region: $LOCATION"
          echo "üè∑ deploymentID: $DEPLOYMENT_ID"